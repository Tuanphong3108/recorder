<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recorder</title>
     <!-- PWA & Favicon -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#0E0E12">
    <!-- Import Google Sans Flex & Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:wght@100..1000&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <style>
        @font-face {
            font-family: 'Minecraft';
            src: url('https://tuanphong3108.github.io/google-sans-do-not-access/minecraft.ttf') format('truetype');
            font-weight: normal; font-style: normal;
        }

        :root {
            /* Purple Theme - Material Design 3 Expressive */
            --md-sys-color-primary: #D0BCFF; 
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-surface: #0E0E12;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-surface-variant: #1D1B20;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-error: #F2B8B5;
            --md-sys-color-on-error: #601410;
            
            /* Spring easing for that smooth pop-in effect */
            --spring-easing: cubic-bezier(0.34, 1.56, 0.64, 1);
            --standard-easing: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: 'Google Sans Flex', sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* INITIAL LOADING OVERLAY */
        #initial-loader {
            position: fixed; inset: 0;
            background-color: var(--md-sys-color-surface);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease, visibility 0.8s;
        }

        .loading-gif {
            width: 140px;
            filter: grayscale(100%) brightness(1.2) sepia(100%) hue-rotate(240deg) saturate(300%);
            margin-bottom: 24px;
        }

        .loading-text-init {
            font-family: 'Minecraft';
            color: var(--md-sys-color-primary);
            font-size: 1.1rem;
            letter-spacing: 4px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.98); }
        }

        header {
            height: 70px; padding: 0 24px;
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }

        .logo-text {
            font-family: 'Minecraft'; font-size: 1.3rem;
            color: var(--md-sys-color-primary); letter-spacing: 1px;
            display: flex; align-items: center; gap: 8px;
        }

        main {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative; padding: 0 20px;
        }

        #canvas { width: 100%; height: 200px; display: none; }

        .loading-overlay-status {
            display: none; flex-direction: column; align-items: center; gap: 12px;
        }

        .bottom-sheet {
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 44px 44px 0 0;
            padding: 24px; display: flex; flex-direction: column;
            align-items: center; gap: 16px;
            transition: height 0.6s var(--spring-easing);
            height: 240px; 
            position: relative;
        }

        .bottom-sheet.expanded { height: 85vh; }

        #libraryWrapper {
            width: 100%; max-width: 500px;
            display: flex; flex-direction: column;
            overflow: hidden; flex: 1;
            opacity: 0; transition: opacity 0.3s;
        }

        .bottom-sheet.expanded #libraryWrapper { opacity: 1; }

        .search-container { 
            margin-bottom: 16px; width: 100%; 
            display: flex; align-items: center; gap: 12px;
        }

        #librarySearch {
            flex: 1;
            background: rgba(255,255,255,0.06);
            border: none; border-radius: 28px; padding: 12px 20px;
            color: white; font-family: 'Google Sans Flex'; font-size: 1rem;
            outline: none; transition: all 0.3s;
        }

        .select-toggle-btn {
            background: rgba(208, 188, 255, 0.1);
            color: var(--md-sys-color-primary);
            border: none; padding: 8px 16px; border-radius: 20px;
            font-family: 'Google Sans Flex'; font-weight: 600; cursor: pointer;
            transition: all 0.2s;
        }
        .select-toggle-btn.active {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        #libraryContainer { width: 100%; overflow-y: auto; flex: 1; padding-bottom: 30px; }

        .recording-card {
            background: rgba(255, 255, 255, 0.04);
            margin-bottom: 12px; padding: 16px; border-radius: 24px;
            display: flex; align-items: center; gap: 16px;
            animation: slideUp 0.5s var(--spring-easing);
            transition: all 0.3s;
            position: relative;
        }

        /* CUSTOM CHECKBOX VỚI HIỆU ỨNG HOVER SÁNG */
        .custom-checkbox {
            width: 24px; height: 24px; border: 2px solid var(--md-sys-color-on-surface-variant);
            border-radius: 6px; display: none; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s var(--standard-easing);
            flex-shrink: 0;
            position: relative;
        }
        
        .custom-checkbox::after {
            content: '';
            position: absolute;
            inset: -8px;
            background: var(--md-sys-color-primary);
            border-radius: 50%;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s var(--standard-easing);
            z-index: -1;
        }

        .custom-checkbox:hover::after {
            opacity: 0.12;
            transform: scale(1);
        }

        .custom-checkbox.visible { display: flex; }
        
        .custom-checkbox.checked {
            background: var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(208, 188, 255, 0.4); 
        }
        
        .custom-checkbox .material-symbols-outlined {
            font-size: 18px; color: var(--md-sys-color-on-primary);
            display: none; font-weight: bold;
        }
        .custom-checkbox.checked .material-symbols-outlined { display: block; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card-top { display: flex; justify-content: space-between; align-items: center; gap: 12px; width: 100%; }

        .record-title {
            font-size: 1.05rem; font-weight: 600; cursor: pointer;
            color: var(--md-sys-color-on-surface);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .delete-btn {
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer; padding: 6px; border-radius: 50%;
            transition: all 0.2s; display: flex;
        }
        .delete-btn:hover { background: rgba(242, 184, 181, 0.2); color: var(--md-sys-color-error); font-variation-settings: 'FILL' 1; }

        .timer { 
            font-size: 4rem; display: none; color: var(--md-sys-color-primary);
            letter-spacing: -2px; font-variation-settings: 'wght' 200, 'wdth' 80;
            transition: opacity 0.3s var(--standard-easing);
        }

        .main-controls { 
            display: flex; align-items: center; gap: 40px; 
            width: 100%; justify-content: center; margin-top: auto;
            position: relative;
            height: 88px;
        }

        .secondary-btn {
            color: var(--md-sys-color-on-surface-variant); cursor: pointer;
            width: 56px; height: 56px; display: flex;
            align-items: center; justify-content: center; border-radius: 50%;
            transition: all 0.4s var(--spring-easing);
        }
        .secondary-btn.active { color: var(--md-sys-color-primary); font-variation-settings: 'FILL' 1; }

        /* NÚT RECORD CHÍNH */
        .record-trigger {
            width: 88px; height: 88px; border-radius: 28px; 
            background-color: #FF5252; color: white;
            border: none; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.5s var(--spring-easing);
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
            font-family: 'Google Sans Flex';
            position: relative;
            z-index: 2;
        }
        .record-trigger:hover { border-radius: 50%; transform: scale(1.08); font-variation-settings: 'FILL' 1; }
        .record-trigger.active { width: 190px; border-radius: 100px; background-color: white; color: black; }
        
        /* HIỆU ỨNG SMOOTH CHO NÚT XÓA */
        .record-trigger.delete-mode {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
            animation: popIn 0.4s var(--spring-easing);
        }

        /* Khi ẩn nút Mic trong chế độ chọn nhưng chưa chọn gì */
        .record-trigger.hidden-scale {
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .label-stop { 
            display: none; font-weight: 900; margin-left: 14px; font-size: 1.3rem; 
            font-variation-settings: 'wght' 900, 'wdth' 125;
            text-transform: uppercase;
        }
        .record-trigger.active .label-stop { display: inline-block; }

        #toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #322F37; color: white; padding: 14px 24px; border-radius: 16px;
            font-weight: 600; font-size: 0.9rem; opacity: 0; visibility: hidden;
            transition: all 0.4s var(--spring-easing); z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            display: flex; align-items: center; gap: 8px;
        }
        #toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }

        audio { width: 100%; height: 36px; border-radius: 18px; filter: hue-rotate(240deg) saturate(1.5); margin-top: 4px; }
        
        #infoModal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #1C1B1F; padding: 32px; border-radius: 40px; z-index: 100;
            width: 85%; max-width: 380px; border: 1px solid var(--md-sys-color-primary);
        }
    </style>
</head>
<body>

    <div id="initial-loader">
        <img src="https://tuanphong3108.github.io/md3-loading/Loading_Indicator.gif" alt="Loading" class="loading-gif">
        <div class="loading-text-init">ĐANG TẢI...</div>
    </div>

    <header>
        <div class="logo-text"><span class="material-symbols-outlined">graphic_eq</span>MÁY GHI ÂM</div>
        <div class="secondary-btn" onclick="toggleModal()"><span class="material-symbols-outlined">info</span></div>
    </header>

    <div id="infoModal">
        <h3 style="font-family: 'Minecraft'; color: var(--md-sys-color-primary); margin-top: 0;">THÔNG TIN</h3>
        <p style="font-size: 1rem; opacity: 0.8; line-height: 1.8;">
            • Phiên bản: 2.9.0 Glow Edition<br>
            • Thiết bị: OPPO A6x Optimized<br>
            • Trạng thái: Hoạt động tốt
        </p>
        <button onclick="toggleModal()" style="width: 100%; padding: 16px; border: none; border-radius: 20px; background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); font-weight: 800; font-family: 'Google Sans Flex'; cursor: pointer;">ĐÓNG</button>
    </div>

    <div id="toast"><span class="material-symbols-outlined" id="toastIcon">check_circle</span> <span id="toastText">Thành công</span></div>

    <main>
        <canvas id="canvas"></canvas>
        <div class="loading-overlay-status" id="statusView">
            <img src="https://tuanphong3108.github.io/md3-loading/Loading_Indicator.gif" id="statusGif" alt="Loading" class="loading-gif" style="width: 120px;">
            <div id="statusText" style="font-family: 'Minecraft'; font-size: 0.85rem; color: var(--md-sys-color-primary); letter-spacing: 2px;">ĐANG XỬ LÝ...</div>
        </div>
    </main>

    <div class="bottom-sheet expanded" id="sheet">
        <div id="timer" class="timer">00:00</div>
        
        <div id="libraryWrapper">
            <div class="search-container">
                <input type="text" id="librarySearch" placeholder="Tìm kiếm bản ghi..." oninput="filterRecords()">
                <button class="select-toggle-btn" id="bulkSelectBtn" onclick="toggleSelectionMode()">Chọn</button>
            </div>
            <div id="libraryContainer"></div>
        </div>

        <div class="main-controls">
            <div class="secondary-btn active" id="libBtn" onclick="handleLibraryControlClick()">
                <span class="material-symbols-outlined" id="libIcon" style="font-size: 2rem;">list</span>
            </div>
            
            <button class="record-trigger" id="recordBtn" title="Nhấn để ghi âm">
                <span class="material-symbols-outlined" id="recordIcon" style="font-size: 2.2rem;">mic</span>
                <span class="label-stop">DỪNG</span>
            </button>
            
            <div style="width: 56px;"></div>
        </div>
    </div>

    <script>
        const recordBtn = document.getElementById('recordBtn');
        const recordIcon = document.getElementById('recordIcon');
        const libBtn = document.getElementById('libBtn');
        const libIcon = document.getElementById('libIcon');
        const timerLabel = document.getElementById('timer');
        const statusView = document.getElementById('statusView');
        const statusText = document.getElementById('statusText');
        const canvas = document.getElementById('canvas');
        const libraryContainer = document.getElementById('libraryContainer');
        const searchInput = document.getElementById('librarySearch');
        const bulkSelectBtn = document.getElementById('bulkSelectBtn');
        const sheet = document.getElementById('sheet');
        const toast = document.getElementById('toast');
        const ctx = canvas.getContext('2d');

        let isRecording = false, seconds = 0, timerInterval;
        let isSelectionMode = false;
        let selectedIds = new Set();
        let audioCtx, analyser, source, stream, mediaRecorder, chunks = [];
        let db;
        let lastDuration = "00:00"; // Lưu thời lượng cuối cùng để lưu vào DB

        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('initial-loader').style.opacity = '0';
                setTimeout(() => document.getElementById('initial-loader').style.visibility = 'hidden', 800);
            }, 1200);
        });

        const request = indexedDB.open("RecorderDB_A6x_v3", 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore("recordings", { keyPath: "id", autoIncrement: true });
        };
        request.onsuccess = e => { db = e.target.result; loadLibrary(); };

        function showToast(text, icon = 'check_circle') {
            document.getElementById('toastText').innerText = text;
            document.getElementById('toastIcon').innerText = icon;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function toggleModal() {
            const m = document.getElementById('infoModal');
            m.style.display = m.style.display === 'block' ? 'none' : 'block';
        }

        function toggleLibrary(forceState) {
            const isExp = forceState !== undefined ? forceState : !sheet.classList.contains('expanded');
            sheet.classList.toggle('expanded', isExp);
            libBtn.classList.toggle('active', isExp);
        }

        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            bulkSelectBtn.classList.toggle('active', isSelectionMode);
            bulkSelectBtn.innerText = isSelectionMode ? "Hủy" : "Chọn";
            selectedIds.clear();
            updateUIForSelectionMode();
            loadLibrary();
        }

        function updateUIForSelectionMode() {
            if (isSelectionMode) {
                libIcon.innerText = "select_all";
                refreshMainActionBtn();
            } else {
                libIcon.innerText = "list";
                recordIcon.innerText = "mic";
                recordBtn.classList.remove('delete-mode', 'hidden-scale');
                recordBtn.style.display = "flex";
            }
        }

        function refreshMainActionBtn() {
            if (!isSelectionMode) return;
            if (selectedIds.size > 0) {
                recordBtn.classList.remove('hidden-scale');
                recordIcon.innerText = "delete";
                recordBtn.classList.add('delete-mode');
            } else {
                recordBtn.classList.add('hidden-scale');
            }
        }

        function handleLibraryControlClick() {
            if (isSelectionMode) {
                const allCheckboxes = document.querySelectorAll('.custom-checkbox');
                const anyUnchecked = Array.from(allCheckboxes).some(cb => !cb.classList.contains('checked'));
                allCheckboxes.forEach(cb => {
                    const id = parseInt(cb.getAttribute('data-id'));
                    if (anyUnchecked) { cb.classList.add('checked'); selectedIds.add(id); }
                    else { cb.classList.remove('checked'); selectedIds.delete(id); }
                });
                refreshMainActionBtn();
            } else {
                toggleLibrary();
            }
        }

        async function initAudio() {
            statusView.style.display = 'flex';
            statusText.innerText = "ĐANG KẾT NỐI...";
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                source = audioCtx.createMediaStreamSource(stream);
                source.connect(analyser);
                mediaRecorder = new MediaRecorder(stream);
                chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    await saveToDB();
                    statusView.style.display = 'none';
                    toggleLibrary(true);
                };
                statusView.style.display = 'none';
                canvas.style.display = 'block';
                timerLabel.style.display = 'block';
                startTimer();
                mediaRecorder.start();
                draw();
            } catch (err) {
                statusText.innerText = "LỖI MIC!";
                setTimeout(() => { isRecording = false; recordBtn.classList.remove('active'); recordIcon.innerText = 'mic'; statusView.style.display = 'none'; }, 2000);
            }
        }

        function startTimer() {
            seconds = 0;
            timerLabel.innerText = "00:00";
            timerInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                lastDuration = `${m}:${s}`;
                timerLabel.innerText = lastDuration;
            }, 1000);
        }

        function resetTimerUI() {
            clearInterval(timerInterval);
            timerLabel.style.display = 'none';
            timerLabel.innerText = "00:00";
            seconds = 0;
        }

        function draw() {
            if (!isRecording) return;
            requestAnimationFrame(draw);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const barW = 8, gap = 6, centerX = canvas.width / 2;
            const bars = Math.floor(canvas.width / (barW + gap));
            for (let i = 0; i < bars; i++) {
                const val = dataArray[i % dataArray.length];
                const h = (val / 255) * 160 + 10;
                ctx.fillStyle = `rgba(208, 188, 255, ${val/255 + 0.3})`;
                const x = centerX + (i - bars/2) * (barW + gap);
                ctx.beginPath();
                ctx.roundRect(x, (canvas.height - h)/2, barW, h, 8);
                ctx.fill();
            }
        }

        async function saveToDB() {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const record = {
                name: `Bản ghi ${new Date().toLocaleTimeString('vi-VN')}`,
                duration: lastDuration,
                data: blob,
                timestamp: Date.now()
            };
            const trans = db.transaction("recordings", "readwrite");
            trans.objectStore("recordings").add(record);
            trans.oncomplete = loadLibrary;
        }

        async function bulkDelete() {
            if (selectedIds.size === 0) return;
            const count = selectedIds.size;
            const trans = db.transaction("recordings", "readwrite");
            const store = trans.objectStore("recordings");
            selectedIds.forEach(id => store.delete(id));
            trans.oncomplete = () => {
                showToast(`Đã xóa ${count} bản ghi`, "delete");
                toggleSelectionMode();
            };
        }

        function loadLibrary() {
            libraryContainer.innerHTML = '';
            const store = db.transaction("recordings", "readonly").objectStore("recordings");
            store.openCursor(null, 'prev').onsuccess = e => {
                const cursor = e.target.result;
                if (cursor) {
                    const data = cursor.value;
                    const url = URL.createObjectURL(data.data);
                    const card = document.createElement('div');
                    card.className = 'recording-card';
                    card.setAttribute('data-name', data.name.toLowerCase());
                    const isChecked = selectedIds.has(data.id);
                    
                    card.innerHTML = `
                        <div class="custom-checkbox ${isSelectionMode ? 'visible' : ''} ${isChecked ? 'checked' : ''}" data-id="${data.id}">
                            <span class="material-symbols-outlined">check</span>
                        </div>
                        <div style="flex:1; display:flex; flex-direction:column; gap:4px; overflow:hidden;">
                            <div class="card-top">
                                <div class="record-title">${data.name}</div>
                                ${!isSelectionMode ? `<span class="material-symbols-outlined delete-btn" onclick="deleteRecord(${data.id})">delete</span>` : ''}
                            </div>
                            <div style="font-size:0.85rem; opacity:0.6;">${data.duration} • ${new Date(data.timestamp).toLocaleDateString('vi-VN')}</div>
                            <audio src="${url}" controls></audio>
                        </div>
                    `;
                    
                    if (isSelectionMode) {
                        card.onclick = () => {
                            const cb = card.querySelector('.custom-checkbox');
                            if (cb.classList.contains('checked')) { cb.classList.remove('checked'); selectedIds.delete(data.id); }
                            else { cb.classList.add('checked'); selectedIds.add(data.id); }
                            refreshMainActionBtn();
                        };
                    }
                    libraryContainer.appendChild(card);
                    cursor.continue();
                }
            };
        }

        function deleteRecord(id) {
            const trans = db.transaction("recordings", "readwrite");
            trans.objectStore("recordings").delete(id);
            trans.oncomplete = loadLibrary;
            showToast("Đã xóa bản ghi", "delete");
        }

        function filterRecords() {
            const term = searchInput.value.toLowerCase();
            document.querySelectorAll('.recording-card').forEach(card => {
                card.style.display = card.getAttribute('data-name').includes(term) ? 'flex' : 'none';
            });
        }

        recordBtn.addEventListener('click', async () => {
            if (isSelectionMode) { bulkDelete(); return; }
            if (!isRecording) {
                isRecording = true;
                recordBtn.classList.add('active');
                recordIcon.innerText = 'stop';
                toggleLibrary(false);
                await initAudio();
            } else {
                isRecording = false;
                if (mediaRecorder) mediaRecorder.stop();
                if (stream) stream.getTracks().forEach(t => t.stop());
                
                // RESET TIMER NGAY KHI DỪNG
                resetTimerUI();
                
                recordBtn.classList.remove('active');
                recordIcon.innerText = 'mic';
                canvas.style.display = 'none';
                statusView.style.display = 'flex';
                statusText.innerText = "ĐANG LƯU...";
            }
        });

        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = 200; };
        window.onresize();
	
	// Đăng ký Service Worker để app chạy offline trên OPPO A6x
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
            .then(reg => console.log('Đã kích hoạt chế độ Offline!'))
            .catch(err => console.log('Lỗi kích hoạt Offline:', err));
    });
}
    </script>
</body>
</html>
